rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null && request.auth.uid != null;
    }

    function appId() {
      return request.resource.data.appId != null
        ? request.resource.data.appId
        : (resource.data.appId != null ? resource.data.appId : null);
    }

    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // Public leaderboard
    match /artifacts/{appId}/public/data/public_profiles/{uid} {
      allow read: if true; // leitura pública

      // o próprio usuário pode criar/atualizar apenas campos permitidos
      allow create, update: if isSelf(uid) &&
        request.resource.data.keys().hasOnly(['displayName', 'points', 'updatedAt']) &&
        (request.resource.data.displayName is string) &&
        (request.resource.data.points is int && request.resource.data.points >= 0);

      allow delete: if false;
    }

    // User-scoped data: tasks and attempts
    match /artifacts/{appId}/users/{uid}/data/app/{collectionId}/{docId} {
      allow read, create, update, delete: if isSelf(uid);
    }

    // Health pings (optionally readable publicly)
    match /artifacts/{appId}/public/health/pings/{uid} {
      allow read: if true;
      allow create, update: if isSelf(uid);
      allow delete: if false;
    }
  }
}
