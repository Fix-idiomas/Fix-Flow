rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null && request.auth.uid != null; }
    function isSelf(uid) { return isSignedIn() && request.auth.uid == uid; }

    // -------------------------
    // HEALTH PINGS (cada usuário no seu doc)
    // Leitura apenas autenticados; escrita só o próprio usuário
    // -------------------------
    match /artifacts/{appId}/public/health/pings/{uid} {
      allow read: if isSignedIn();
      allow write: if isSelf(uid);
    }

    // -------------------------
    // PERFIL PÚBLICO (ranking)
    // Leitura pública; cada usuário só cria/atualiza o próprio
    // -------------------------
    match /artifacts/{appId}/public/data/public_profiles/{uid} {
      allow read: if true;
      allow create, update: if isSelf(uid);
      allow delete: if false;
    }

    // -------------------------
    // TAREFAS DO USUÁRIO
    // -------------------------
    match /artifacts/{appId}/users/{uid}/data/app/tasks/{taskId} {
      allow read, write: if isSelf(uid);
    }

    // -------------------------
    // ATIVIDADE DO DIA — GLOBAL (desafio do dia)
    // Leitura para autenticados; ESCRITA apenas admin (allowlist em public/data/admins/{uid})
    // Caminho: artifacts/{APP_ID}/public/data/daily_activity/current
    // -------------------------
    match /artifacts/{appId}/public/data/daily_activity/{docId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && exists(/databases/$(database)/documents/artifacts/$(appId)/public/data/admins/$(request.auth.uid));
    }

    // -------------------------
    // ATIVIDADE DO DIA — POR PROFESSOR (cada prof no seu doc)
    // Leitura para autenticados; ESCRITA só pelo próprio professor
    // Caminho: artifacts/{APP_ID}/public/data/daily_activity_by_teacher/{teacherUid}
    // -------------------------
    match /artifacts/{appId}/public/data/daily_activity_by_teacher/{teacherUid} {
      allow read: if isSignedIn();
      allow write: if isSelf(teacherUid);
    }

    // -------------------------
    // ATTEMPTS DO USUÁRIO (submissões do runner)
    // -------------------------
    match /artifacts/{appId}/users/{uid}/data/app/attempts/{attemptId} {
      allow create, read: if isSelf(uid);
      allow update, delete: if false;
    }

    // -------------------------
    // FEEDBACK DO USUÁRIO
    // Cada usuário cria seus próprios feedbacks; leitura opcional só do próprio; sem update/delete
    // Caminho: artifacts/{APP_ID}/users/{uid}/data/app/feedback/{feedbackId}
    // -------------------------
    match /artifacts/{appId}/users/{uid}/data/app/feedback/{feedbackId} {
      allow create: if isSelf(uid);
      allow read: if isSelf(uid);
      allow update, delete: if false;
    }

    // -------------------------
    // ADMIN ALLOWLIST
    // Crie doc vazio: artifacts/{APP_ID}/public/data/admins/{adminUid}
    // (Bloqueado via API; gerencie pelo Console)
    // -------------------------
    match /artifacts/{appId}/public/data/admins/{adminUid} {
      allow read, write: if false;
    }
  }
}
